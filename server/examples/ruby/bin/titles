#!/usr/bin/env ruby

require_relative '../lib/protob_pb'
require_relative '../lib/protob_services_pb'
require 'csv'

def main
  output = CSV.open('output.csv', 'w:utf-8')
  output << ['ID', 'Pages Num', 'Names Num', 'Names/Page', 'Score']
  stub = Protob::BHLIndex::Stub.new('172.22.247.23:8888', :this_channel_is_insecure)
  stub.titles(Protob::Void.new).each_with_index do |t, i|
    names_num = 0
    t.pages.each do |p|
      p.names.each do |n|
        names_num += 1 if n.odds > 100
      end
    end
    pages_num = t.pages.size
    output << [t.id, pages_num, names_num, names_num.to_f / pages_num,
               names_num * pages_num]
    next unless (i % 1000).zero?
    puts Time.now
    puts i
    puts t.path
    puts t.pages.count
    output.flush
  end
  output.close
end

main
